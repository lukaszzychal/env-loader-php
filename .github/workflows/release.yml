name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick
        tools: composer:v2
    
    - name: Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-8.1-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-8.1-composer-
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Validate composer.json
      run: composer validate --strict
    
    - name: Run tests
      run: composer test
    
    - name: Run PHPStan
      run: composer phpstan
    
    - name: Run PHP CodeSniffer
      run: composer cs-check
    
    - name: Generate changelog
      id: changelog
      run: |
        # Extract version from tag (remove 'v' prefix)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Generate changelog for this version
        echo "## Changes in v$VERSION" > release_notes.md
        echo "" >> release_notes.md
        
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          echo "### What's Changed" >> release_notes.md
          git log --pretty=format:"- %s" $PREV_TAG..HEAD >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        # Add installation instructions
        echo "### Installation" >> release_notes.md
        echo "" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "composer require lukaszzychal/env-loader:^$VERSION" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        
        # Add full changelog
        echo "**Full Changelog**: https://github.com/$GITHUB_REPOSITORY/compare/$PREV_TAG...v$VERSION" >> release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.changelog.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify Packagist
      if: success()
      run: |
        echo "Release created successfully! Please update Packagist manually or configure webhook for automatic updates."
        echo "Packagist URL: https://packagist.org/packages/lukaszzychal/env-loader"
        echo "Webhook URL: https://packagist.org/api/github?username=lukaszzychal"

  packagist:
    name: Update Packagist
    runs-on: ubuntu-latest
    needs: release
    if: success()
    
    steps:
    - name: Update Packagist
      run: |
        # This step will be triggered after successful release
        # You can add Packagist webhook URL here if you have the API key
        echo "Packagist should be updated via webhook or manually"
        echo "Package URL: https://packagist.org/packages/lukaszzychal/env-loader"
